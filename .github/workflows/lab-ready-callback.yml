name: Notify Backend When Lab is Ready

on:
  workflow_call:
    inputs:
      student_username:
        required: true
        type: string
      status:
        required: false
        type: string
        default: "ready"

jobs:
  notify-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Get Auth0 token
        id: auth
        run: |
          TOKEN=$(curl -s --request POST \
            --url https://${{ secrets.AUTH0_DOMAIN }}/oauth/token \
            --header 'content-type: application/json' \
            --data '{
              "grant_type": "client_credentials",
              "client_id": "${{ secrets.AUTH0_CLIENT_ID }}",
              "client_secret": "${{ secrets.AUTH0_CLIENT_SECRET }}",
              "audience": "${{ secrets.AUTH0_AUDIENCE }}"
            }' | jq -r .access_token)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Notify backend when lab is ${{ inputs.status }}
        run: |
          curl -X POST https://lab-backend.cloudmentor.hu/lab-ready \
            -H "Authorization: Bearer ${{ steps.auth.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "${{ inputs.student_username }}",
              "status": "${{ inputs.status }}"
            }'
